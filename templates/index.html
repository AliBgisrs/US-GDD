<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Fire Risk</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #1a1a1a; color: white; }
        .header { background: #b71c1c; padding: 20px; text-align: center; border-bottom: 5px solid #ff5252; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        #map { height: 450px; width: 100%; border-radius: 12px; border: 2px solid #444; margin-bottom: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; display: none; }
        .stat-card { background: #2d2d2d; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .risk-num { font-size: 3rem; font-weight: bold; margin: 10px 0; }
        .instruction { text-align: center; color: #aaa; font-style: italic; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0;">ðŸ”¥ US Real-Time Fire Risk Dashboard</h1>
    <div style="font-size: 0.9em; margin-top: 5px;">Developed by Ali Bazrafkan | 701-729-9088</div>
</div>

<div class="container">
    <p class="instruction">Click anywhere on the map to begin real-time monitoring.</p>
    <div id="map"></div>

    <div id="dashboard" class="dashboard">
        <div class="stat-card" style="grid-column: span 1;">
            <strong>FIRE RISK SCORE</strong>
            <div id="risk" class="risk-num">--</div>
            <div id="timer" style="font-size: 0.8em; color: #888;">Refreshing in 60s</div>
        </div>
        <div class="stat-card"><strong>Air Temp</strong><div id="temp" class="risk-num" style="font-size: 1.5rem;">--</div></div>
        <div class="stat-card"><strong>Humidity</strong><div id="hum" class="risk-num" style="font-size: 1.5rem;">--</div></div>
        <div class="stat-card"><strong>Wind Speed</strong><div id="wind" class="risk-num" style="font-size: 1.5rem;">--</div></div>
        <div class="stat-card"><strong>Soil Temp</strong><div id="soil" class="risk-num" style="font-size: 1.5rem;">--</div></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([39.82, -98.57], 4);
    
    // Using OpenStreetMap Standard (Free, No Key Required)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let activeCoords = null;
    let secondsLeft = 60;
    let marker = null;

    map.on('click', function(e) {
        activeCoords = e.latlng;
        if (marker) map.removeLayer(marker);
        marker = L.marker(activeCoords).addTo(map);
        fetchData();
    });

    function fetchData() {
        if (!activeCoords) return;
        
        fetch('/get_risk_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({lat: activeCoords.lat, lon: activeCoords.lng})
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('risk').innerText = data.risk;
            document.getElementById('temp').innerText = data.temp + "Â°C";
            document.getElementById('hum').innerText = data.humidity + "%";
            document.getElementById('wind').innerText = data.wind + " km/h";
            document.getElementById('soil').innerText = data.soil_temp + "Â°C";

            // Update color logic
            const riskEl = document.getElementById('risk');
            if (data.risk > 70) riskEl.style.color = "#ff1744";
            else if (data.risk > 40) riskEl.style.color = "#ff9100";
            else riskEl.style.color = "#00e676";

            secondsLeft = 60;
        });
    }

    setInterval(() => {
        if (activeCoords) {
            secondsLeft--;
            document.getElementById('timer').innerText = `Refreshing in ${secondsLeft}s`;
            if (secondsLeft <= 0) fetchData();
        }
    }, 1000);
</script>
</body>
</html>